includeConfig "${projectDir}/conf/base.config"
params {
    sample_sheet = "samplesheet.csv"
    basecall_model = "dna_r10.4.1_e8.2_400bps_sup@v5.2.0"
    basecall_modifications = "5mCG_5hmCG"
    filter_reads = "-ml 50 -mq 7 -rd"
    sequencing_kit = "SQK-LSK110"
    reference = "GrCh38.fa"
    outdir = "results"
}

profiles {
    hpc {
        process {
            executor = 'slurm'
            queue = 'mpcs.p'

            cpus = { 2 * task.attempt }
            memory = { 16.GB * task.attempt }
            time = { 7.d * task.attempt }
            container = 'ghcr.io/maurya-anand/nf-ont-methpro:1.0.0'

            // Process-specific resource requirements
            withName: ONT_BASECALL {
                queue = 'mpcg.p'
                clusterOptions = '--gpus-per-node=4'
                cpus = { 16 * task.attempt }
                memory = { 96.GB * task.attempt }
                time = { 7.d * task.attempt }
            }

            withName: 'ALIGNMENT|METHYLATION_CALL' {
                queue = 'mpcs.p'
                cpus = { 16 * task.attempt }
                memory = { 128.GB * task.attempt }
                time = { 7.d * task.attempt }
            }

            withName: 'VARIANT_CALL' {
                container = 'kishwars/pepper_deepvariant:r0.8'
                queue = 'mpcs.p'
                cpus = { 16 * task.attempt }
                memory = { 128.GB * task.attempt }
                time = { 7.d * task.attempt }
            }

            withName: 'SUMMARY' {
                queue = 'mpcs.p'
                cpus = { 2 * task.attempt }
                memory = { 16.GB * task.attempt }
                time = { 1.h * task.attempt }
            }
        }
        workDir = "${System.getenv('WORK')}/ont-methpro_work"
        singularity.enabled = true
        singularity.autoMounts = true
        singularity.cacheDir = "${projectDir}/container"
        singularity.pullTimeout = '1h'
        singularity.runOptions = '--nv'
        conda.enabled = false
        docker.enabled = false
        podman.enabled = false
        shifter.enabled = false
        charliecloud.enabled = false
        apptainer.enabled = false
    }
    debug {
        process.beforeScript = 'echo $HOSTNAME'
        cleanup = false
        nextflow.enable.configProcessNamesValidation = true
    }
    conda {
        conda.enabled = true
        docker.enabled = false
        singularity.enabled = false
        podman.enabled = false
        shifter.enabled = false
        charliecloud.enabled = false
        conda.channels = ['conda-forge', 'bioconda']
        apptainer.enabled = false
    }
    mamba {
        conda.enabled = true
        conda.useMamba = true
        docker.enabled = false
        singularity.enabled = false
        podman.enabled = false
        shifter.enabled = false
        charliecloud.enabled = false
        apptainer.enabled = false
    }
    docker {
        docker.enabled = true
        conda.enabled = false
        singularity.enabled = false
        podman.enabled = false
        shifter.enabled = false
        charliecloud.enabled = false
        apptainer.enabled = false
        docker.runOptions = '-u $(id -u):$(id -g)'
    }
    arm64 {
        process.arch = 'arm64'
        // TODO https://github.com/nf-core/modules/issues/6694
        // For now if you're using arm64 you have to use wave for the sake of the maintainers
        // wave profile
        apptainer.ociAutoPull = true
        singularity.ociAutoPull = true
        wave.enabled = true
        wave.freeze = true
        wave.strategy = 'conda,container'
    }
    emulate_amd64 {
        docker.runOptions = '-u $(id -u):$(id -g) --platform=linux/amd64'
    }
    singularity {
        singularity.enabled = true
        singularity.autoMounts = true
        singularity.cacheDir = "${projectDir}/container"
        conda.enabled = false
        docker.enabled = false
        podman.enabled = false
        shifter.enabled = false
        charliecloud.enabled = false
        apptainer.enabled = false
    }
    podman {
        podman.enabled = true
        conda.enabled = false
        docker.enabled = false
        singularity.enabled = false
        shifter.enabled = false
        charliecloud.enabled = false
        apptainer.enabled = false
    }
    shifter {
        shifter.enabled = true
        conda.enabled = false
        docker.enabled = false
        singularity.enabled = false
        podman.enabled = false
        charliecloud.enabled = false
        apptainer.enabled = false
    }
    charliecloud {
        charliecloud.enabled = true
        conda.enabled = false
        docker.enabled = false
        singularity.enabled = false
        podman.enabled = false
        shifter.enabled = false
        apptainer.enabled = false
    }
    apptainer {
        apptainer.enabled = true
        apptainer.autoMounts = true
        conda.enabled = false
        docker.enabled = false
        singularity.enabled = false
        podman.enabled = false
        shifter.enabled = false
        charliecloud.enabled = false
    }
    wave {
        apptainer.ociAutoPull = true
        singularity.ociAutoPull = true
        wave.enabled = true
        wave.freeze = true
        wave.strategy = 'conda,container'
    }
    gpu {
        docker.runOptions = '-u $(id -u):$(id -g) --gpus all'
        apptainer.runOptions = '--nv'
        singularity.runOptions = '--nv'
    }
}
